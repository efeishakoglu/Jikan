<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hierodule: USB Module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Hierodule
   &#160;<span id="projectnumber">1.6.0</span>
   </div>
   <div id="projectbrief">Utility module set for STM32 MCUs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_u_s_b__usage.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">USB Module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_USB_USAGE"></a></p>
<p>This module only covers the CDC mode for the USB peripheral, which lets you</p><ul>
<li>Unidirectionally parse the data received, which is kept in a ring buffer.</li>
<li>Set up the data to be transmitted during the next transmission.</li>
<li>Assign a callback routine to be invoked at the end of a transmission.</li>
</ul>
<p><a class="el" href="struct_h_i_e_r_o_d_u_l_e___u_s_b___wrapper.html">HIERODULE_USB_Wrapper</a> is the main item in the module, with the instance of which you can access the variables related to the ring buffer and use the module routines to implement your USB comm procedure.</p>
<p>The module does not address peripheral configuration and initialization, it is assumed those are performed beforehand. Make sure to have configured your USB peripheral accordingly.</p>
<p><br  />
First, update the CDC_Receive_FS routine defined within within usbd_cdc_if.c so that the module's reception callback routine will be invoked whenever an incoming transmission has been completed. Simply, add an include directive to the module at the top, then add a call to <a class="el" href="group___u_s_b___public.html#ga8c8ac028728ee3d0b9412199f0e71e84">HIERODULE_USB_Receive_Callback</a> right before the routine's return statement. </p><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  usbd_cdc_if.c</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="hierodule__usb_8h.html">hierodule_usb.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  ...</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  ...</span></div>
<div class="line"><span class="comment"> *  within CDC_Receive_FS body</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="group___u_s_b___public.html#ga8c8ac028728ee3d0b9412199f0e71e84">HIERODULE_USB_Receive_Callback</a>(Buf, Len);</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  return ...</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="ttc" id="agroup___u_s_b___public_html_ga8c8ac028728ee3d0b9412199f0e71e84"><div class="ttname"><a href="group___u_s_b___public.html#ga8c8ac028728ee3d0b9412199f0e71e84">HIERODULE_USB_Receive_Callback</a></div><div class="ttdeci">void HIERODULE_USB_Receive_Callback(uint8_t *Buf, uint32_t *Len)</div><div class="ttdoc">Callback function that updates the ring buffer and invokes TC_Handler if it's not NULL.</div><div class="ttdef"><b>Definition:</b> <a href="hierodule__usb_8c_source.html#l00116">hierodule_usb.c:116</a></div></div>
<div class="ttc" id="ahierodule__usb_8h_html"><div class="ttname"><a href="hierodule__usb_8h.html">hierodule_usb.h</a></div><div class="ttdoc">: Header file for the USB module.</div></div>
</div><!-- fragment --><p> Except the painfully simplifed syntax and omitted source code, it should pretty much look like this.</p>
<p><br  />
<br  />
Optionally, you can define a callback routine to be called at the end of a transmission. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> TC_Handler(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This will be performed at the end of a transmission.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p> You can also just pass a null pointer if you do not need anything done at the end of the transmission.</p>
<p><br  />
<br  />
Next, initialize the wrapper with the callback routine and an arbitrary RX buffer size, 24 for this instance. </p><div class="fragment"><div class="line"><a class="code" href="group___u_s_b___public.html#ga232a93434f5f74c5aa57a5f404714e87">HIERODULE_USB_InitWrapper</a>(24, TC_Handler);</div>
<div class="ttc" id="agroup___u_s_b___public_html_ga232a93434f5f74c5aa57a5f404714e87"><div class="ttname"><a href="group___u_s_b___public.html#ga232a93434f5f74c5aa57a5f404714e87">HIERODULE_USB_InitWrapper</a></div><div class="ttdeci">void HIERODULE_USB_InitWrapper(uint16_t RX_BufferSize, void(*TC_Handler)(void))</div><div class="ttdoc">Initializes the wrapper for the USB peripheral.</div><div class="ttdef"><b>Definition:</b> <a href="hierodule__usb_8c_source.html#l00078">hierodule_usb.c:78</a></div></div>
</div><!-- fragment --><p><br  />
And that's it! The peripheral, and consequently the module, should be able to handle the incoming transmissions from the host. To set up data to be transmitted at the next transmission commenced by the host, simply use <a class="el" href="group___u_s_b___public.html#ga5c9a38acd408ad0c73af753589d7a59f">HIERODULE_USB_TransmitPackage</a> </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *TX_Buffer = <span class="stringliteral">&quot;Hello World!\n&quot;</span>;</div>
<div class="line">uint32_t Size = strlen(TX_Buffer);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="group___u_s_b___public.html#ga5c9a38acd408ad0c73af753589d7a59f">HIERODULE_USB_TransmitPackage</a>(TX_Buffer, Size);</div>
<div class="ttc" id="agroup___u_s_b___public_html_ga5c9a38acd408ad0c73af753589d7a59f"><div class="ttname"><a href="group___u_s_b___public.html#ga5c9a38acd408ad0c73af753589d7a59f">HIERODULE_USB_TransmitPackage</a></div><div class="ttdeci">void HIERODULE_USB_TransmitPackage(uint8_t *TX_Buffer, uint32_t Size)</div><div class="ttdoc">Sets up the data to be transmitted.</div><div class="ttdef"><b>Definition:</b> <a href="hierodule__usb_8c_source.html#l00104">hierodule_usb.c:104</a></div></div>
</div><!-- fragment --><p> The first parameter to the routine is really an uint8_t pointer; your compiler might warn you about implicit casts, but you should be fine as long as it's a c-type string, a pointer or an array of uint8_t, char etc. <br  />
Likewise, use the same routine to set up the data response for the next transmission inside your transmission complete callback. You can parse the received bytes via <a class="el" href="group___u_s_b___public.html#ga0cbba30a33c80475406ff8adcfb559fb">HIERODULE_USB_GetNextByte</a>. Or, you can directly access the buffer contents with the wrapper's instance, that's declared within the header file as extern. </p><div class="fragment"><div class="line"><a class="code" href="group___u_s_b___public.html#ga58c9bfaf906117f5eb61f70070e886ec">Wrapper</a>.<a class="code" href="struct_h_i_e_r_o_d_u_l_e___u_s_b___wrapper.html#a06e5864462c7f5bbc46fca19023726ed">RX_Buffer</a>;</div>
<div class="ttc" id="agroup___u_s_b___public_html_ga58c9bfaf906117f5eb61f70070e886ec"><div class="ttname"><a href="group___u_s_b___public.html#ga58c9bfaf906117f5eb61f70070e886ec">Wrapper</a></div><div class="ttdeci">HIERODULE_USB_Wrapper Wrapper</div><div class="ttdoc">Extern declaration for the wrapper instance in the source file.</div><div class="ttdef"><b>Definition:</b> <a href="hierodule__usb_8c_source.html#l00027">hierodule_usb.c:27</a></div></div>
<div class="ttc" id="astruct_h_i_e_r_o_d_u_l_e___u_s_b___wrapper_html_a06e5864462c7f5bbc46fca19023726ed"><div class="ttname"><a href="struct_h_i_e_r_o_d_u_l_e___u_s_b___wrapper.html#a06e5864462c7f5bbc46fca19023726ed">HIERODULE_USB_Wrapper::RX_Buffer</a></div><div class="ttdeci">uint8_t * RX_Buffer</div><div class="ttdoc">The ring buffer where the data received is appended.</div><div class="ttdef"><b>Definition:</b> <a href="hierodule__usb_8h_source.html#l00058">hierodule_usb.h:58</a></div></div>
</div><!-- fragment --><p><br  />
Finally, you can "release" the wrapper to save memory. </p><div class="fragment"><div class="line"><a class="code" href="group___u_s_b___public.html#gad3ad45ef1104b00aac9674cb3dcc1ebf">HIERODULE_USB_ReleaseWrapper</a>();</div>
<div class="ttc" id="agroup___u_s_b___public_html_gad3ad45ef1104b00aac9674cb3dcc1ebf"><div class="ttname"><a href="group___u_s_b___public.html#gad3ad45ef1104b00aac9674cb3dcc1ebf">HIERODULE_USB_ReleaseWrapper</a></div><div class="ttdeci">void HIERODULE_USB_ReleaseWrapper(void)</div><div class="ttdoc">De-initializes the wrapper for the USB peripheral.</div><div class="ttdef"><b>Definition:</b> <a href="hierodule__usb_8c_source.html#l00095">hierodule_usb.c:95</a></div></div>
</div><!-- fragment --><p> This merely frees the ring buffer address and nullifies it. Make sure to initialize the wrapper with adequate buffer size before accessing it again. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
